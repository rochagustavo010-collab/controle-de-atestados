<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alcans - Gestão de Atestados</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0b0f1a; color: #fff; margin: 0; }
        .text-alcans { color: #FF5C00; }
        .bg-alcans { background-color: #FF5C00; }
        .card-atestado { border-radius: 1.2rem; padding: 1.2rem; margin-bottom: 1rem; position: relative; color: #1e293b; }
        .status-25 { background-color: #c4d4e3; }
        .status-50 { background-color: #f3efb5; }
        .status-75 { background-color: #f3efb5; }
        .status-100 { background-color: #c6e3d0; }
        .progress-track { height: 8px; background: rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: #4f46e5; transition: width 0.5s ease; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://zxjegvonpiuyfplkonkb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4amVndm9ucGl1eWZwbGtvbmtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDQwNjMsImV4cCI6MjA4MjQyMDA2M30.P-EkAuX1LiM5hybYYVaaUvMd04LgV7w0-GDkealXbwo';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const App = () => {
            const [files, setFiles] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => { loadFiles(); }, []);

            const loadFiles = async () => {
                const { data } = await supabaseClient.storage.from('atestados').list();
                if (data) setFiles(data);
            };

            const forceDelete = async (name) => {
                if(!confirm("Deseja forçar a exclusão deste arquivo?")) return;
                setLoading(true);
                
                // Tentativa 1: Nome direto
                let { error } = await supabaseClient.storage.from('atestados').remove([name]);
                
                // Tentativa 2: Se falhar, tenta limpar caracteres especiais (fallback)
                if (error) {
                    const decodedName = decodeURIComponent(name);
                    const { error: error2 } = await supabaseClient.storage.from('atestados').remove([decodedName]);
                    if (error2) alert("Erro persistente: " + error2.message);
                }

                await loadFiles();
                setLoading(false);
            };

            const cleanOldFiles = async () => {
                if(!confirm("Isso removerá apenas arquivos com erro. Continuar?")) return;
                setLoading(true);
                const toDelete = files.filter(f => !f.name.startsWith('V5-')).map(f => f.name);
                if(toDelete.length > 0) {
                    await supabaseClient.storage.from('atestados').remove(toDelete);
                }
                await loadFiles();
                setLoading(false);
            };

            const getInfo = (name) => {
                const p = name.split('-');
                if (name.includes('ST4')) return { p: 100, c: 'status-100' };
                if (name.includes('ST3')) return { p: 75, c: 'status-75' };
                if (name.includes('ST2')) return { p: 50, c: 'status-50' };
                return { p: 25, c: 'status-25' };
            };

            return (
                <div className="min-h-screen p-4 max-w-2xl mx-auto">
                    {loading && <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center font-black text-alcans">LIMPANDO ARQUIVO...</div>}
                    
                    <header className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-black text-alcans italic leading-none">ALCANS</h1>
                        <button onClick={cleanOldFiles} className="text-[10px] bg-red-600/20 text-red-500 px-3 py-1 rounded border border-red-500/30 font-bold uppercase">
                            Limpar Arquivos com Erro
                        </button>
                    </header>

                    <div className="space-y-4">
                        {files.map(f => {
                            const info = getInfo(f.name);
                            const p = f.name.split('-');
                            const isV5 = f.name.startsWith('V5-');
                            const { data } = supabaseClient.storage.from('atestados').getPublicUrl(f.name);

                            return (
                                <div key={f.name} className={`card-atestado ${info.c}`}>
                                    <button onClick={() => forceDelete(f.name)} className="absolute top-4 right-4 text-red-600 font-bold text-xl hover:scale-125 transition">✕</button>
                                    
                                    <div className="flex gap-4 items-center">
                                        <img src={data.publicUrl} className="w-16 h-16 rounded-xl bg-black/10 object-cover" onError={e => e.target.src='https://via.placeholder.com/64?text=?'} />
                                        <div className="flex-1">
                                            <h2 className="font-black text-sm uppercase truncate pr-6">
                                                {!isV5 ? "⚠️ ARQUIVO TRAVADO" : (p[4]?.replace(/_/g, ' ') || 'S/ NOME')}
                                            </h2>
                                            <p className="text-[10px] font-bold opacity-60 uppercase truncate">
                                                {isV5 ? (p[5]?.replace(/_/g, ' ') || 'S/ UNIDADE') : f.name}
                                            </p>
                                        </div>
                                    </div>

                                    <div className="progress-track"><div className="progress-fill" style={{ width: `${info.p}%` }}></div></div>
                                    
                                    <div className="flex justify-between text-[8px] font-black uppercase opacity-70">
                                        <span>Etapa Atual: {info.p}%</span>
                                        {!isV5 && <span className="text-red-700">FORMATO INVÁLIDO</span>}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
